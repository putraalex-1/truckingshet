<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Check Sheet Pemeriksaan Truck Packing Receiving WJF - Quality Control System">
    <title>Check Sheet Pemeriksaan Truck - WJF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0a4d3c;
            --primary-light: #0d6b50;
            --primary-dark: #083d2f;
            --accent: #ff6b35;
            --accent-light: #ff8555;
            --bg: #f8faf9;
            --surface: #ffffff;
            --text: #1a1a1a;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-lg: rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8faf9 0%, #e8f5f0 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-out;
            padding-bottom: 40px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: clamp(25px, 5vw, 40px);
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        header h1 {
            color: white;
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            line-height: 1.2;
        }

        header p {
            color: rgba(255,255,255,0.95);
            font-size: clamp(0.9rem, 2vw, 1rem);
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: clamp(20px, 4vw, 30px);
            margin-bottom: 20px;
            box-shadow: 0 2px 15px var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px var(--shadow-lg);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section h2 {
            color: var(--primary);
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            font-weight: 700;
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--accent);
            display: inline-block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 18px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--bg);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(10, 77, 60, 0.08);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Inter', sans-serif;
        }

        .checklist-item {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: clamp(16px, 3vw, 20px);
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            border-color: var(--primary-light);
            background: white;
            transform: translateX(4px);
        }

        .checklist-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .checklist-header h3 {
            flex: 1 1 auto;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            font-weight: 600;
            color: var(--text);
            min-width: 200px;
        }

        .category-badge {
            background: var(--primary);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .radio-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .radio-option {
            position: relative;
            flex: 1 1 auto;
            min-width: fit-content;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-option label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            background: white;
            margin-bottom: 0;
        }

        .radio-option input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(10, 77, 60, 0.2);
        }

        .radio-option input[type="radio"]:focus + label {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Photo Upload Styles */
        .photo-upload-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border);
        }

        .photo-upload-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .upload-button {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(10, 77, 60, 0.3);
        }

        .upload-button input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .photo-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: var(--bg);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-preview-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow-lg);
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2;
        }

        .photo-preview-item:hover .photo-delete-btn {
            opacity: 1;
        }

        /* Photo Modal */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .photo-modal.active {
            display: flex;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: var(--text);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notes-input {
            width: 100%;
            min-height: 60px;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px var(--shadow-lg);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 800;
            display: block;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.85rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .btn {
            flex: 1 1 auto;
            min-width: fit-content;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--text);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-lg);
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .radio-group {
                flex-direction: column;
            }

            .radio-option {
                width: 100%;
            }

            .radio-option label {
                width: 100%;
                justify-content: flex-start;
            }

            .photo-preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-ok {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-not-ok {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        .status-na {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã Check Sheet Pemeriksaan Truck</h1>
            <p>Packing Receiving WJF - Quality Control System</p>
        </header>

        <div class="summary-card" id="summaryCard" style="display: none;">
            <h2 style="margin-bottom: 5px; font-size: 1.3rem;">üìä Ringkasan Pemeriksaan</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-value" id="totalOK">0</span>
                    <span class="summary-label">‚úÖ OK</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="totalNotOK">0</span>
                    <span class="summary-label">‚ùå Not OK</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="totalNA">0</span>
                    <span class="summary-label">‚ûñ N/A</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="progressPercent">0%</span>
                    <span class="summary-label">Progress</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="form-section">
                <h2>üìù Informasi Dasar</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tanggal">Tanggal</label>
                        <input type="date" id="tanggal" required>
                    </div>
                    <div class="form-group">
                        <label for="waktu">Waktu</label>
                        <input type="time" id="waktu" required>
                    </div>
                    <div class="form-group">
                        <label for="supplier">Nama Supplier</label>
                        <input type="text" id="supplier" placeholder="Contoh: PT ABC">
                    </div>
                    <div class="form-group">
                        <label for="driver">Nama Driver</label>
                        <input type="text" id="driver" placeholder="Nama lengkap driver">
                    </div>
                    <div class="form-group">
                        <label for="nomorTruck">Nomor Polisi Truck</label>
                        <input type="text" id="nomorTruck" placeholder="B 1234 XYZ">
                    </div>
                    <div class="form-group">
                        <label for="inspector">Checker</label>
                        <input type="text" id="inspector" placeholder="Nama inspector">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="form-section">
                <h2>‚úÖ Checklist Pemeriksaan</h2>
                <div id="checklistContainer"></div>
            </div>
        </div>

        <div class="card">
            <div class="form-section">
                <h2>üìù Kesimpulan & Remark</h2>
                <div class="form-group">
                    <label for="conclusion">Kesimpulan</label>
                    <select id="conclusion">
                        <option value="">-- Pilih Kesimpulan --</option>
                        <option value="approved">‚úÖ Disetujui - Truck dalam kondisi baik</option>
                        <option value="conditional">‚ö†Ô∏è Disetujui dengan catatan - Ada perbaikan minor</option>
                        <option value="rejected">‚ùå Ditolak - Truck tidak memenuhi standar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="overallNotes">Remark Keseluruhan</label>
                    <textarea id="overallNotes" placeholder="Catatan tambahan, rekomendasi, atau hal-hal penting lainnya..."></textarea>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveData()">
                    üíæ Simpan Data
                </button>
                <button class="btn btn-success" onclick="saveToDatabase()">
                    ‚òÅÔ∏è Simpan ke Database
                </button>
                <button class="btn btn-secondary" onclick="exportToPDF()">
                    üìÑ Export PDF
                </button>
                <button class="btn btn-danger" onclick="resetForm()">
                    üîÑ Reset Form
                </button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="photo-modal" id="photoModal">
        <button class="photo-modal-close" onclick="closePhotoModal()">√ó</button>
        <img class="photo-modal-content" id="modalImage" src="" alt="Photo">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Configuration - GANTI dengan URL server Anda
        const API_URL = 'http://localhost:3000/api';

        const checklistItems = [
            { id: 1, title: 'Kondisi fisik truck (tidak ada kerusakan)', category: 'Fisik' },
            { id: 2, title: 'Kebersihan truck (bersih dari kotoran/sampah)', category: 'Kebersihan' },
            { id: 3, title: 'Kondisi ban (tidak kempes/aus)', category: 'Teknis' },
            { id: 4, title: 'Lampu (semua berfungsi dengan baik)', category: 'Teknis' },
            { id: 5, title: 'Rem berfungsi dengan baik', category: 'Teknis' },
            { id: 6, title: 'Klakson berfungsi', category: 'Teknis' },
            { id: 7, title: 'Spion lengkap dan tidak rusak', category: 'Fisik' },
            { id: 8, title: 'Plat nomor terpasang dan jelas', category: 'Dokumen' },
            { id: 9, title: 'STNK masih berlaku', category: 'Dokumen' },
            { id: 10, title: 'KIR masih berlaku (untuk truck besar)', category: 'Dokumen' },
            { id: 11, title: 'Kondisi kabin driver (bersih dan aman)', category: 'Kebersihan' },
            { id: 12, title: 'Terpal/penutup cargo dalam kondisi baik', category: 'Fisik' },
            { id: 13, title: 'Lantai cargo bersih dan kering', category: 'Kebersihan' },
            { id: 14, title: 'Tidak ada bau menyengat di cargo', category: 'Kebersihan' },
            { id: 15, title: 'Sistem pengaman cargo (tali/jaring) memadai', category: 'Keamanan' },
            { id: 16, title: 'APAR (Alat Pemadam Api Ringan) tersedia', category: 'Keamanan' },
            { id: 17, title: 'Segitiga pengaman tersedia', category: 'Keamanan' },
            { id: 18, title: 'P3K (Kotak pertolongan pertama) tersedia', category: 'Keamanan' },
            { id: 19, title: 'Driver menggunakan seragam/identitas', category: 'Administrasi' },
            { id: 20, title: 'Surat jalan/delivery order lengkap', category: 'Administrasi' }
        ];

        const inspectionData = {
            basic: {},
            items: {},
            notes: {},
            photos: {}, // Format: { itemId: [base64Images] }
            conclusion: '',
            overallNotes: ''
        };

        function generateChecklist() {
            const container = document.getElementById('checklistContainer');
            
            checklistItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item';
                itemDiv.innerHTML = `
                    <div class="checklist-header">
                        <h3>${item.id}. ${item.title}</h3>
                        <span class="category-badge">${item.category}</span>
                    </div>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="ok-${item.id}" name="item-${item.id}" value="ok" onchange="updateSummary()">
                            <label for="ok-${item.id}">‚úÖ OK</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="not-ok-${item.id}" name="item-${item.id}" value="not-ok" onchange="updateSummary()">
                            <label for="not-ok-${item.id}">‚ùå Not OK</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="na-${item.id}" name="item-${item.id}" value="na" onchange="updateSummary()">
                            <label for="na-${item.id}">‚ûñ N/A</label>
                        </div>
                    </div>
                    <textarea class="notes-input" id="notes-${item.id}" placeholder="Remark (opsional)..."></textarea>
                    
                    <div class="photo-upload-section">
                        <div class="photo-upload-container">
                            <label class="upload-button">
                                üì∑ Tambah Foto
                                <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(${item.id}, this.files)">
                            </label>
                            <div class="photo-preview-grid" id="photos-${item.id}"></div>
                        </div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        function handlePhotoUpload(itemId, files) {
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('‚ùå File terlalu besar! Maksimal 5MB per foto');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!inspectionData.photos[itemId]) {
                        inspectionData.photos[itemId] = [];
                    }
                    
                    // Resize image to reduce size
                    resizeImage(e.target.result, 1200, (resizedImage) => {
                        inspectionData.photos[itemId].push(resizedImage);
                        displayPhotos(itemId);
                        saveData(); // Auto-save after photo upload
                        showToast('‚úÖ Foto berhasil ditambahkan');
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function resizeImage(base64, maxWidth, callback) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                callback(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = base64;
        }

        function displayPhotos(itemId) {
            const container = document.getElementById(`photos-${itemId}`);
            if (!container) return;

            const photos = inspectionData.photos[itemId] || [];
            
            container.innerHTML = photos.map((photo, index) => `
                <div class="photo-preview-item" onclick="openPhotoModal('${photo}')">
                    <img src="${photo}" alt="Photo ${index + 1}">
                    <button class="photo-delete-btn" onclick="deletePhoto(${itemId}, ${index}, event)">√ó</button>
                </div>
            `).join('');
        }

        function deletePhoto(itemId, photoIndex, event) {
            event.stopPropagation();
            if (confirm('Hapus foto ini?')) {
                inspectionData.photos[itemId].splice(photoIndex, 1);
                if (inspectionData.photos[itemId].length === 0) {
                    delete inspectionData.photos[itemId];
                }
                displayPhotos(itemId);
                saveData();
                showToast('üóëÔ∏è Foto berhasil dihapus');
            }
        }

        function openPhotoModal(photoSrc) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = photoSrc;
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
        }

        function updateSummary() {
            let ok = 0, notOk = 0, na = 0, total = checklistItems.length;

            checklistItems.forEach(item => {
                const selected = document.querySelector(`input[name="item-${item.id}"]:checked`);
                if (selected) {
                    if (selected.value === 'ok') ok++;
                    else if (selected.value === 'not-ok') notOk++;
                    else if (selected.value === 'na') na++;
                }
            });

            document.getElementById('totalOK').textContent = ok;
            document.getElementById('totalNotOK').textContent = notOk;
            document.getElementById('totalNA').textContent = na;
            
            const checked = ok + notOk + na;
            const progress = Math.round((checked / total) * 100);
            document.getElementById('progressPercent').textContent = progress + '%';
            
            document.getElementById('summaryCard').style.display = checked > 0 ? 'block' : 'none';
        }

        function collectFormData() {
            const data = {
                tanggal: document.getElementById('tanggal').value,
                waktu: document.getElementById('waktu').value,
                supplier: document.getElementById('supplier').value,
                driver: document.getElementById('driver').value,
                nomorTruck: document.getElementById('nomorTruck').value,
                inspector: document.getElementById('inspector').value,
                overallNotes: document.getElementById('overallNotes').value,
                conclusion: document.getElementById('conclusion').value,
                items: {},
                notes: {},
                photos: inspectionData.photos
            };

            checklistItems.forEach(item => {
                const selected = document.querySelector(`input[name="item-${item.id}"]:checked`);
                if (selected) {
                    data.items[item.id] = selected.value;
                }
                const notes = document.getElementById(`notes-${item.id}`).value;
                if (notes) {
                    data.notes[item.id] = notes;
                }
            });

            return data;
        }

        function saveData() {
            const data = collectFormData();
            try {
                localStorage.setItem('truckInspectionData', JSON.stringify(data));
                showToast('‚úÖ Data berhasil disimpan lokal!');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('‚ùå Storage penuh! Hapus beberapa foto atau simpan ke database');
                } else {
                    showToast('‚ùå Gagal menyimpan data: ' + e.message);
                }
            }
        }

        async function saveToDatabase() {
            const data = collectFormData();
            
            if (!data.supplier || !data.nomorTruck) {
                showToast('‚ùå Isi data supplier dan nomor truck terlebih dahulu!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/inspections`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('‚úÖ Data berhasil disimpan ke database!');
                    console.log('Saved with ID:', result.id);
                } else {
                    throw new Error('Gagal menyimpan ke database');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Gagal menyimpan ke database. Pastikan server aktif!');
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('truckInspectionData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    document.getElementById('tanggal').value = data.tanggal || '';
                    document.getElementById('waktu').value = data.waktu || '';
                    document.getElementById('supplier').value = data.supplier || '';
                    document.getElementById('driver').value = data.driver || '';
                    document.getElementById('nomorTruck').value = data.nomorTruck || '';
                    document.getElementById('inspector').value = data.inspector || '';
                    document.getElementById('overallNotes').value = data.overallNotes || '';
                    document.getElementById('conclusion').value = data.conclusion || '';

                    checklistItems.forEach(item => {
                        if (data.items[item.id]) {
                            const radio = document.querySelector(`input[name="item-${item.id}"][value="${data.items[item.id]}"]`);
                            if (radio) radio.checked = true;
                        }
                        if (data.notes[item.id]) {
                            document.getElementById(`notes-${item.id}`).value = data.notes[item.id];
                        }
                    });

                    if (data.photos) {
                        inspectionData.photos = data.photos;
                        Object.keys(data.photos).forEach(itemId => {
                            displayPhotos(parseInt(itemId));
                        });
                    }

                    updateSummary();
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function resetForm() {
            if (confirm('Apakah Anda yakin ingin reset form? Data yang belum disimpan akan hilang.')) {
                localStorage.removeItem('truckInspectionData');
                location.reload();
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            const lineHeight = 6;

            function checkPageOverflow(additionalHeight = 10) {
                if (yPos + additionalHeight > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                    return true;
                }
                return false;
            }
            
            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('CHECK SHEET PEMERIKSAAN TRUCK', 105, yPos, { align: 'center' });
            yPos += 7;
            doc.setFontSize(12);
            doc.text('Packing Receiving WJF', 105, yPos, { align: 'center' });
            yPos += 15;

            // Informasi Dasar
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const info = [
                `Tanggal: ${document.getElementById('tanggal').value}`,
                `Waktu: ${document.getElementById('waktu').value}`,
                `Nama Supplier: ${document.getElementById('supplier').value}`,
                `Nama Driver: ${document.getElementById('driver').value}`,
                `Nomor Polisi: ${document.getElementById('nomorTruck').value}`,
                `Checker: ${document.getElementById('inspector').value}`
            ];

            info.forEach(line => {
                checkPageOverflow();
                doc.text(line, margin, yPos);
                yPos += lineHeight;
            });

            yPos += 5;

            // Checklist Results
            checkPageOverflow(15);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Hasil Pemeriksaan:', margin, yPos);
            yPos += 8;

            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');

            checklistItems.forEach(item => {
                checkPageOverflow(15);
                
                const selected = document.querySelector(`input[name="item-${item.id}"]:checked`);
                const status = selected ? selected.value.toUpperCase() : 'N/A';
                const notes = document.getElementById(`notes-${item.id}`).value;
                const photoCount = inspectionData.photos[item.id] ? inspectionData.photos[item.id].length : 0;
                
                doc.text(`${item.id}. ${item.title}`, margin, yPos);
                doc.text(`[${status}]`, 150, yPos);
                yPos += 5;
                
                if (notes) {
                    doc.setFontSize(8);
                    const splitNotes = doc.splitTextToSize(`   Remark: ${notes}`, 170);
                    splitNotes.forEach(line => {
                        checkPageOverflow();
                        doc.text(line, margin, yPos);
                        yPos += 5;
                    });
                    doc.setFontSize(9);
                }

                if (photoCount > 0) {
                    doc.setFontSize(8);
                    doc.text(`   üì∑ ${photoCount} foto terlampir`, margin, yPos);
                    yPos += 5;
                    doc.setFontSize(9);
                }

                yPos += 2;
            });

            // Kesimpulan
            yPos += 5;
            checkPageOverflow(15);

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Kesimpulan:', margin, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            const conclusion = document.getElementById('conclusion').selectedOptions[0]?.text || '-';
            doc.text(conclusion, margin, yPos);

            // Catatan Keseluruhan
            yPos += 10;
            const overallNotes = document.getElementById('overallNotes').value;
            if (overallNotes) {
                checkPageOverflow(15);
                doc.setFont(undefined, 'bold');
                doc.text('Remark Keseluruhan:', margin, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const splitNotes = doc.splitTextToSize(overallNotes, 170);
                splitNotes.forEach(line => {
                    checkPageOverflow();
                    doc.text(line, margin, yPos);
                    yPos += 5;
                });
            }

            const filename = `Inspection_${document.getElementById('nomorTruck').value || 'unknown'}_${document.getElementById('tanggal').value || 'nodate'}.pdf`;
            doc.save(filename);
            showToast('üìÑ PDF berhasil diexport!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            generateChecklist();
            loadData();
            
            // Set default date and time
            const now = new Date();
            const dateInput = document.getElementById('tanggal');
            const timeInput = document.getElementById('waktu');
            
            if (!dateInput.value) {
                dateInput.valueAsDate = now;
            }
            if (!timeInput.value) {
                timeInput.value = now.toTimeString().slice(0, 5);
            }

            // Auto-save on input change (debounced)
            let saveTimeout;
            const autoSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    const savedData = localStorage.getItem('truckInspectionData');
                    if (savedData) {
                        saveData();
                    }
                }, 2000);
            };

            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('change', autoSave);
            });

            // Close modal on background click
            document.getElementById('photoModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePhotoModal();
                }
            });
        });

        // Prevent accidental page close
        window.addEventListener('beforeunload', (e) => {
            const hasData = document.getElementById('supplier').value || 
                           document.getElementById('driver').value || 
                           document.getElementById('nomorTruck').value;
            
            if (hasData && !localStorage.getItem('truckInspectionData')) {
                e.preventDefault();
                e.returnValue = 'Data belum disimpan. Yakin ingin keluar?';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>
